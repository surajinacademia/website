---
import fs from "node:fs";
import path from "node:path";
import PageLayout from "@/layouts/Base.astro";
import "@fancyapps/ui/dist/fancybox/fancybox.css";

const meta = {
	description: "Photography and visual work by Suraj Sahu",
	title: "Photography",
};

const portfolioDir = path.join(process.cwd(), "public", "portfolio");
const imageFiles = fs.existsSync(portfolioDir)
	? fs
			.readdirSync(portfolioDir)
			.filter((f) => /\.(jpg|jpeg|png|webp|gif)$/i.test(f))
			.sort()
	: [];

// Reference layout: two columns (flex w-full md:w-1/2), items in each column are full or half width
const leftCol = imageFiles.filter((_, i) => i % 2 === 0);
const rightCol = imageFiles.filter((_, i) => i % 2 === 1);

function getItemWidthClass(index: number) {
	// Pattern: full, half, half, full, half, half...
	return index % 3 === 0 ? "w-full" : "w-full md:w-1/2";
}
---

<PageLayout meta={meta}>
	<div class="container mx-auto">
		<h1 class="pt-10 pb-8 text-4xl font-bold">PHOTOGRAPHY</h1>
		<section class="text-neutral-700 dark:text-neutral-300">
			<div class="container w-full">
				<div class="flex w-full flex-wrap">
					<!-- Left column -->
					<div class="flex w-full flex-wrap md:w-1/2">
						{
							leftCol.map((filename, i) => {
								const thumbFilename = filename.replace(/\.(jpg|jpeg|png)$/i, ".webp");
								const imageAlt = filename.replace(/\.[^.]+$/, "").replace(/[-_]/g, " ");
								return (
									<div class={`p-1 ${getItemWidthClass(i)}`}>
										<div class="portfolio-image-container h-full w-full overflow-hidden">
											<a
												href={`/portfolio/${filename}`}
												data-fancybox="gallery"
												data-caption={imageAlt}
												class="portfolio-link focus:ring-offset-global-bg dark:focus:ring-accent block cursor-pointer focus:ring-2 focus:ring-offset-2"
											>
												<img
													src={`/portfolio-thumbs/${thumbFilename}`}
													alt={imageAlt}
													class="portfolio-image block h-full w-full scale-100 transform object-cover object-center transition-all duration-700 ease-out hover:scale-110"
													loading="lazy"
													decoding="async"
													width="800"
													height="600"
												/>
											</a>
										</div>
									</div>
								);
							})
						}
					</div>
					<!-- Right column -->
					<div class="flex w-full flex-wrap md:w-1/2">
						{
							rightCol.map((filename, i) => {
								const thumbFilename = filename.replace(/\.(jpg|jpeg|png)$/i, ".webp");
								const imageAlt = filename.replace(/\.[^.]+$/, "").replace(/[-_]/g, " ");
								return (
									<div class={`p-1 ${getItemWidthClass(i)}`}>
										<div class="portfolio-image-container h-full w-full overflow-hidden">
											<a
												href={`/portfolio/${filename}`}
												data-fancybox="gallery"
												data-caption={imageAlt}
												class="portfolio-link focus:ring-offset-global-bg dark:focus:ring-accent block cursor-pointer focus:ring-2 focus:ring-offset-2"
											>
												<img
													src={`/portfolio-thumbs/${thumbFilename}`}
													alt={imageAlt}
													class="portfolio-image block h-full w-full scale-100 transform object-cover object-center transition-all duration-700 ease-out hover:scale-110"
													loading="lazy"
													decoding="async"
													width="800"
													height="600"
												/>
											</a>
										</div>
									</div>
								);
							})
						}
					</div>
				</div>
			</div>
		</section>
	</div>

	{
		imageFiles.length === 0 && (
			<div class="container mx-auto px-5 md:px-20">
				<p class="text-global-text/80 text-sm">
					Add photos to{" "}
					<code class="rounded bg-gray-200 px-1 dark:bg-gray-700">public/portfolio/</code> to see
					them here.
				</p>
			</div>
		)
	}
</PageLayout>

<script>
	import { Fancybox } from "@fancyapps/ui";
	
	// Initialize fancybox when DOM is ready
	document.addEventListener("DOMContentLoaded", () => {
		// Initialize intersection observer for smooth image fade-in
		const imageContainers = document.querySelectorAll(".portfolio-image-container");
		const imageObserver = new IntersectionObserver(
			(entries) => {
				entries.forEach((entry) => {
					if (entry.isIntersecting) {
						entry.target.classList.add("is-visible");
						imageObserver.unobserve(entry.target);
					}
				});
			},
			{
				rootMargin: "50px",
				threshold: 0.1,
			}
		);
		
		imageContainers.forEach((container) => {
			imageObserver.observe(container);
		});
		
		// Initialize Fancybox (options object typed to satisfy bind overload)
		Fancybox.bind("[data-fancybox]", {
			Toolbar: {
				display: {
					left: ["infobar"],
					middle: [],
					right: ["close"],
				},
			},
			Thumbs: {
				autoStart: false,
			},
			Image: {
				zoom: true,
				wheel: "slide",
			},
			Carousel: {
				Navigation: {
					prevTpl: '<button class="fancybox__nav fancybox__nav--prev" title="Previous"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 18l-6-6 6-6"/></svg></button>',
					nextTpl: '<button class="fancybox__nav fancybox__nav--next" title="Next"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18l6-6-6-6"/></svg></button>',
				},
			},
			closeButton: "top",
			backdrop: "classic",
		} as never);
	});
</script>

<style>
	.portfolio-image-container {
		opacity: 0;
		transform: translateY(20px);
		transition: opacity 0.6s ease-out, transform 0.6s ease-out;
	}
	
	.portfolio-image-container.is-visible {
		opacity: 1;
		transform: translateY(0);
	}
	
	.portfolio-link {
		display: block;
		transition: transform 0.3s ease-out;
	}
	
	.portfolio-link:hover {
		transform: translateY(-2px);
	}
	
	.portfolio-image {
		will-change: transform;
		backface-visibility: hidden;
		-webkit-backface-visibility: hidden;
	}
	
	/* Smooth cursor pointer */
	.portfolio-link {
		cursor: zoom-in;
	}
</style>
